<!-- app/views/payments/new.html.erb -->
<div class="max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md">
  <h1 class="text-2xl font-bold mb-6 text-center">Subscribe to Premium</h1>

  <%= form_with url: payments_path, id: "payment-form", data: { omise_pub_key: ENV["OMISE_PUBLIC_KEY"] } do |f| %>
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-4">Select a Plan</h2>
      <div class="space-y-2">
        <div class="flex items-center">
          <%= f.radio_button :plan, "monthly", class: "h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500", checked: true %>
          <%= f.label :plan_monthly, "Monthly - ฿299/month", class: "ml-2 block text-sm font-medium text-gray-700" %>
        </div>
        <div class="flex items-center">
          <%= f.radio_button :plan, "annual", class: "h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" %>
          <%= f.label :plan_annual, "Annual - ฿2,990/year (Save 17%)", class: "ml-2 block text-sm font-medium text-gray-700" %>
        </div>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-4">Payment Information</h2>
      <div class="space-y-4">
        <!-- Card Number -->
        <div>
          <label for="card_number" class="block text-sm font-medium text-gray-700">Card Number</label>
          <div class="mt-1">
            <input id="card_number" class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="1234 5678 9012 3456" />
          </div>
        </div>

        <!-- Expiration and CVC -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="card_expiration" class="block text-sm font-medium text-gray-700">Expiration (MM/YY)</label>
            <div class="mt-1">
              <input id="card_expiration" class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="MM/YY" />
            </div>
          </div>
          <div>
            <label for="card_cvc" class="block text-sm font-medium text-gray-700">CVC</label>
            <div class="mt-1">
              <input id="card_cvc" class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="123" />
            </div>
          </div>
        </div>

        <!-- Name on Card -->
        <div>
          <label for="card_name" class="block text-sm font-medium text-gray-700">Name on Card</label>
          <div class="mt-1">
            <input id="card_name" class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="John Doe" />
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden field for Omise Token -->
    <%= f.hidden_field :omise_token %>

    <!-- Submit Button -->
    <div>
      <%= f.submit "Subscribe Now", id: "submit-button", class: "w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
    </div>
  <% end %>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the form and button elements
        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');

        // Get the public key from the form's data attribute
        const omisePublicKey = form.dataset.omisePubKey;

        // Initialize Omise with the public key
        if (typeof Omise !== 'undefined') {
            Omise.setPublicKey(omisePublicKey);
        } else {
            console.error('Omise.js is not loaded. Please check your script inclusion.');
        }

        // Handle form submission
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // Disable the submit button to prevent repeated clicks
            submitButton.disabled = true;
            submitButton.value = 'Processing...';

            // Create a token with Omise
            Omise.createToken('card', {
                name: document.getElementById('card_name').value,
                number: document.getElementById('card_number').value,
                expiration_month: document.getElementById('card_expiration').value.split('/')[0],
                expiration_year: document.getElementById('card_expiration').value.split('/')[1],
                security_code: document.getElementById('card_cvc').value
            }, function(statusCode, response) {
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.value = 'Subscribe Now';

                if (response.object === 'token') {
                    // Set the token value in the hidden field
                    document.getElementById('omise_token').value = response.id;

                    // Submit the form
                    form.submit();
                } else {
                    // Display an error message
                    alert(response.message);
                    console.error(response);
                }
            });
        });
    });
</script>