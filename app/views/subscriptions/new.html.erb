<% content_for :title, "Subscribe to SmartEdu" %>

<div class="max-w-4xl mx-auto p-6 bg-base-100 rounded-lg shadow-lg mt-4">
  <h1 class="text-2xl font-bold mb-4">Choose Your Subscription Plan</h1>

  <% if alert %>
    <div class="alert alert-error mb-4">
      <%= alert %>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
    <% Subscription::PLANS.each do |plan_key, plan| %>
      <div class="card shadow-md">
        <div class="card-body">
          <h2 class="card-title"><%= plan[:name] %></h2>
          <p class="text-xl font-semibold"><%= number_to_currency(plan[:amount]/100, unit: "à¸¿") %> / <%= plan[:interval] %></p>

          <%= form_with(url: subscriptions_path, method: :post, data: { turbo: false }) do |form| %>
            <%= form.hidden_field :plan_name, value: plan_key %>
            <script type="text/javascript" src="https://cdn.omise.co/omise.js"
                    data-key="<%= Rails.application.credentials.dig(:omise, :public_key) %>"
                    data-image="https://www.example.com/images/logo.png"
                    data-frame-label="SmartEdu"
                    data-button-label="Pay now"
                    data-submit-label="Pay"
                    data-amount="<%= plan[:amount] %>"
                    data-currency="thb"
                    data-default-payment-method="credit_card">
            </script>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // When Omise.js has successfully tokenized the card
        window.addEventListener('omiseTokenCreated', function(e) {
            // The token is in e.detail
            let form = e.target.closest('form');

            // Create a hidden input for the token
            let hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'omise_token');
            hiddenInput.setAttribute('value', e.detail);

            // Append the token input to the form
            form.appendChild(hiddenInput);

            // Submit the form
            form.submit();
        });
    });
</script>