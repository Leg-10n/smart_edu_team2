<% content_for :title, "Subscribe to SmartEdu" %>

<div class="max-w-4xl mx-auto p-6 bg-base-100 rounded-lg shadow-lg mt-4">
  <h1 class="text-2xl font-bold mb-4">Choose Your Subscription Plan</h1>

  <% if alert %>
    <div class="alert alert-error mb-4">
      <%= alert %>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
    <% Subscription::PLANS.each do |plan_key, plan| %>
      <div class="card shadow-md">
        <div class="card-body">
          <h2 class="card-title"><%= plan[:name] %></h2>
          <p class="text-xl font-semibold"><%= number_to_currency(plan[:amount]/100, unit: "฿") %> / <%= plan[:interval] %></p>

          <!-- Form using the simple Omise form approach -->
          <%= form_with(url: subscriptions_path, method: :post, id: "payment-form-#{plan_key}", data: { turbo: false }) do |form| %>
            <%= form.hidden_field :plan_name, value: plan_key %>

            <!-- Omise.js will replace this button with its payment form -->
            <script type="text/javascript"
                    src="https://cdn.omise.co/omise.js"
                    data-key="<%= Rails.application.credentials.dig(:omise, :public_key) %>"
                    data-image="https://www.example.com/images/logo.png"
                    data-frame-label="SmartEdu"
                    data-button-label="Pay now"
                    data-submit-label="Pay <%= number_to_currency(plan[:amount]/100, unit: "฿") %>"
                    data-amount="<%= plan[:amount] %>"
                    data-currency="thb"
                    data-default-payment-method="credit_card"
                    data-other-payment-methods="">
            </script>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Add debugging to see what parameters are being sent -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form[id^="payment-form-"]');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                // Let the form submit normally, but log what's happening
                console.log('Form submitted:', this.id);
                // Wait a moment to check if the token was added
                setTimeout(() => {
                    const tokenInput = this.querySelector('input[name="omiseToken"]');
                    console.log('Token input:', tokenInput ? tokenInput.value : 'Not found');
                }, 100);
            });
        });
    });
</script>