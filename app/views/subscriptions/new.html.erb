<% content_for :title, "Subscribe to SmartEdu" %>

<div class="max-w-4xl mx-auto p-6 bg-base-100 rounded-lg shadow-lg mt-4">
  <h1 class="text-2xl font-bold mb-4">Choose Your Subscription Plan</h1>

  <% if alert %>
    <div class="alert alert-error mb-4">
      <%= alert %>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
    <% Subscription::PLANS.each do |plan_key, plan| %>
      <div class="card shadow-md">
        <div class="card-body">
          <h2 class="card-title"><%= plan[:name] %></h2>
          <p class="text-xl font-semibold"><%= number_to_currency(plan[:amount]/100, unit: "à¸¿") %> / <%= plan[:interval] %></p>

          <form action="<%= subscriptions_path %>" method="post" class="checkout-form" data-plan="<%= plan_key %>">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <%= hidden_field_tag 'subscription[plan_name]', plan_key %>
            <!-- This will be replaced by omise.js token on submit -->
            <input type="hidden" name="omise_token" />
            <button type="button" class="btn btn-primary checkout-button" data-amount="<%= plan[:amount] %>">
              Subscribe Now
            </button>
          </form>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Include Omise.js -->
<script src="https://cdn.omise.co/omise.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Configure Omise
        Omise.setPublicKey("<%= Rails.application.credentials.dig(:omise, :public_key) %>");

        // Add click handlers to all checkout buttons
        document.querySelectorAll('.checkout-button').forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                const form = this.closest('form');
                const amount = parseInt(this.getAttribute('data-amount'));

                // Open Omise form
                Omise.createToken('card', {
                    amount: amount
                }, function(statusCode, response) {
                    console.log('Omise response:', statusCode, response);

                    if (statusCode === 200 && response.token) {
                        // Set the token value
                        form.querySelector('input[name="omise_token"]').value = response.token;

                        // Submit form
                        form.submit();
                    } else {
                        // Display error message
                        alert('Payment failed: ' + (response.message || 'Unknown error'));
                    }
                });
            });
        });
    });
</script>